.PHONY: help setup init up down restart logs clean clean-all status

help: ## Mostra esta mensagem de ajuda
	@echo "ETL Receita Federal - Comandos dispon√≠veis:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

setup: ## Configura o ambiente (cria diret√≥rios e .env)
	@echo "üì¶ Criando diret√≥rios necess√°rios..."
	@mkdir -p dags logs plugins data/downloads data/extracted config
	@echo "‚úì Diret√≥rios criados"
	@if [ ! -f .env ]; then \
		echo "üìù Criando arquivo .env..."; \
		echo "# Configura√ß√µes do Docker Compose" > .env; \
		echo "AIRFLOW_UID=$$(id -u)" >> .env; \
		echo "AIRFLOW_PROJ_DIR=." >> .env; \
		echo "" >> .env; \
		echo "# Credenciais do Airflow Web UI" >> .env; \
		echo "_AIRFLOW_WWW_USER_USERNAME=airflow" >> .env; \
		echo "_AIRFLOW_WWW_USER_PASSWORD=airflow" >> .env; \
		echo "" >> .env; \
		echo "# Bibliotecas Python adicionais" >> .env; \
		echo "_PIP_ADDITIONAL_REQUIREMENTS=beautifulsoup4>=4.9.3 bs4>=0.0.1 lxml>=4.6.3 numpy>=1.20.3 pandas>=1.2.4 psycopg2-binary>=2.9.1 python-dotenv==1.0.0 requests==2.30.0 SQLAlchemy>=1.4.18 wget>=3.2" >> .env; \
		echo "" >> .env; \
		echo "# Configura√ß√µes do ETL" >> .env; \
		echo "OUTPUT_FILES_PATH=/opt/airflow/data/downloads" >> .env; \
		echo "EXTRACTED_FILES_PATH=/opt/airflow/data/extracted" >> .env; \
		echo "" >> .env; \
		echo "# Configura√ß√µes do PostgreSQL - Dados RFB" >> .env; \
		echo "DB_HOST=postgres-dados-rfb" >> .env; \
		echo "DB_PORT=5432" >> .env; \
		echo "DB_USER=postgres" >> .env; \
		echo "DB_PASSWORD=postgres" >> .env; \
		echo "DB_NAME=Dados_RFB" >> .env; \
		echo "‚úì Arquivo .env criado"; \
	else \
		echo "‚ö†Ô∏è  Arquivo .env j√° existe, pulando..."; \
	fi
	@echo ""
	@echo "‚úì Setup completo! Agora execute: make init"

init: ## Inicializa o banco de dados do Airflow
	@echo "üöÄ Inicializando Airflow..."
	@docker-compose up airflow-init
	@echo ""
	@echo "‚úì Airflow inicializado! Agora execute: make up"

up: ## Inicia todos os servi√ßos
	@echo "üöÄ Iniciando servi√ßos..."
	@docker-compose up -d
	@echo ""
	@echo "‚úì Servi√ßos iniciados!"
	@echo ""
	@echo "Acesse as interfaces:"
	@echo "  üåê Airflow Web UI: http://localhost:8080 (airflow/airflow)"
	@echo "  üêò PgAdmin:        http://localhost:5050 (admin@admin.com/admin)"
	@echo ""
	@echo "Aguarde alguns minutos para os servi√ßos ficarem prontos."
	@echo "Monitore com: make logs"

down: ## Para todos os servi√ßos
	@echo "üõë Parando servi√ßos..."
	@docker-compose down
	@echo "‚úì Servi√ßos parados"

restart: ## Reinicia todos os servi√ßos
	@echo "üîÑ Reiniciando servi√ßos..."
	@docker-compose restart
	@echo "‚úì Servi√ßos reiniciados"

logs: ## Mostra logs de todos os servi√ßos
	@docker-compose logs -f

logs-scheduler: ## Mostra logs do scheduler
	@docker-compose logs -f airflow-scheduler

logs-webserver: ## Mostra logs do webserver
	@docker-compose logs -f airflow-webserver

logs-postgres: ## Mostra logs do PostgreSQL
	@docker-compose logs -f postgres-dados-rfb

status: ## Mostra status dos servi√ßos
	@docker-compose ps

shell-airflow: ## Abre shell no container do Airflow
	@docker exec -it airflow-scheduler bash

shell-postgres: ## Abre psql no PostgreSQL
	@docker exec -it postgres-dados-rfb psql -U postgres -d Dados_RFB

clean: ## Remove containers e networks (mant√©m volumes)
	@echo "üßπ Limpando containers e networks..."
	@docker-compose down
	@echo "‚úì Limpeza conclu√≠da (volumes preservados)"

clean-all: ## Remove TUDO (containers, networks, volumes) ‚ö†Ô∏è CUIDADO!
	@echo "‚ö†Ô∏è  ATEN√á√ÉO: Isso vai apagar TODOS os dados!"
	@read -p "Tem certeza? Digite 'sim' para confirmar: " confirm; \
	if [ "$$confirm" = "sim" ]; then \
		echo "üßπ Removendo tudo..."; \
		docker-compose down -v; \
		sudo rm -rf logs/* data/downloads/* data/extracted/*; \
		echo "‚úì Tudo removido"; \
	else \
		echo "‚ùå Opera√ß√£o cancelada"; \
	fi

test-connection: ## Testa conex√£o com o PostgreSQL
	@echo "üîç Testando conex√£o com PostgreSQL..."
	@docker exec postgres-dados-rfb pg_isready -U postgres
	@docker exec postgres-dados-rfb psql -U postgres -d Dados_RFB -c "SELECT version();" || echo "Banco ainda n√£o est√° pronto"

backup-db: ## Cria backup do banco de dados
	@echo "üíæ Criando backup do banco de dados..."
	@mkdir -p backups
	@docker exec postgres-dados-rfb pg_dump -U postgres Dados_RFB | gzip > backups/backup_$$(date +%Y%m%d_%H%M%S).sql.gz
	@echo "‚úì Backup criado em backups/"

stats: ## Mostra estat√≠sticas de uso do Docker
	@echo "üìä Estat√≠sticas do Docker:"
	@docker system df

first-run: setup init up ## Configura√ß√£o completa do zero (setup + init + up)
	@echo ""
	@echo "üéâ Tudo pronto!"
	@echo ""
	@echo "Pr√≥ximos passos:"
	@echo "  1. Acesse http://localhost:8080"
	@echo "  2. Fa√ßa login com: airflow / airflow"
	@echo "  3. Ative a DAG 'etl_receita_federal'"
	@echo "  4. Execute a DAG clicando no bot√£o Play"
	@echo ""
	@echo "‚è±Ô∏è  O processo completo pode levar v√°rias horas!"

